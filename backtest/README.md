# MCI価格予想バックテストツール

第8章の価格予想原理に基づく月次バックテストツール

---

## 📋 目次

1. [概要](#概要)
2. [予想手法](#予想手法)
3. [ツール使用方法](#ツール使用方法)
4. [バックテスト結果](#バックテスト結果)
5. [データソース](#データソース)

---

## 概要

このディレクトリには、MCI（Mikan Currency Index）モデルを使った為替レート月次予想のバックテストツールが含まれています。

### 対象通貨ペア
- **USD/JPY**: 米ドル/日本円
- **USD/TRY**: 米ドル/トルコリラ
- **TRY/JPY**: トルコリラ/日本円

### 対象期間
- **データ期間**: 2022-01 〜 2025-11（47ヶ月）
- **バックテスト期間**: 2022-03 〜 2025-11（45ヶ月の予想）

---

## 予想手法

### 基本原理

**過去3カ月のm座標変動の平均**を使って翌月の為替レートを予想します。

### 予想プロセス

N+1月を予想する場合：

1. **変動量の計算**
   - N-2月、N-1月、N月の各月について、前月からのm座標変動（Δm）を計算

2. **3カ月平均の算出**
   ```
   avg_Δm = (Δm_{N-2} + Δm_{N-1} + Δm_{N}) / 3
   ```

3. **予想m座標の計算**
   ```
   m_{N+1}^{pred} = m_N + avg_Δm
   ```

4. **予想為替レートの計算**
   ```
   S_{A/B} = PPP_{A/B} × exp(m[A] - m[B])
   ```

### 特徴

- ✓ **シンプル**: 単一シナリオで明確
- ✓ **適応的**: 各月の実際のトレンドに追随
- ✓ **ニュートラル**: 構造的バイアスが少ない
- ✓ **実務的**: 直近の市場動向を反映

---

## ツール使用方法

### 1. バックテスト実行

#### `backtest_with_rolling_avg.py`
3カ月平均を使った月次予想バックテスト

**単一月のテスト:**
```bash
python backtest_with_rolling_avg.py --base-month 2022-03
```

**出力例:**
```
=== Backtest: 2022-03 → 2022-04 ===

3-month average deltas used:
  USD: +0.017735
  JPY: +0.002217
  TRY: -0.019952

Predictions vs Actual:
  USDJPY: 120.31 vs 126.05 (error: -4.55%)
  USDTRY: 15.16 vs 14.71 (error: +3.06%)
  TRYJPY: 7.94 vs 8.57 (error: -7.39%)
```

**全期間の包括的バックテスト:**
```bash
python backtest_with_rolling_avg.py --comprehensive
```

**カスタム出力ファイル:**
```bash
python backtest_with_rolling_avg.py --comprehensive --output my_results.csv
```

**出力ファイル:**
- デフォルト: `backtest_rolling_avg_results.csv`
- 45ヶ月分の予想結果（2022-03 〜 2025-11）

---

### 2. 結果分析

#### `analyze_rolling_avg_results.py`
バックテスト結果の詳細分析

**全期間の分析:**
```bash
python analyze_rolling_avg_results.py
```

**安定期のみ分析（2023-08以降）:**
```bash
python analyze_rolling_avg_results.py 2023-08
```

**出力内容:**
- 精度指標（平均誤差、MAE、RMSE）
- 誤差分布（0-1%, 1-2%, 2-3%, ...）
- 最も外れた予想 Top 5
- バイアス評価
- 総合評価

---

## バックテスト結果

### 全期間（2022-03〜2025-11、45ヶ月）

| 通貨ペア | 件数 | 平均誤差 | 平均絶対誤差 | RMSE | バイアス |
|---------|------|----------|-------------|------|---------|
| USDJPY  | 45   | +0.00%   | **2.42%**   | 3.32%| ニュートラル |
| USDTRY  | 45   | +0.17%   | **2.23%**   | 3.65%| ニュートラル |
| TRYJPY  | 45   | -0.03%   | **3.84%**   | 4.97%| ニュートラル |

**総合評価:**
- **平均MAE: 2.83%**
- **平均RMSE: 3.98%**
- **評価: [GOOD] 良好な精度**

---

### 安定期（2023-08〜2025-11、28ヶ月）

| 通貨ペア | 件数 | 平均誤差 | 平均絶対誤差 | RMSE | バイアス |
|---------|------|----------|-------------|------|---------|
| USDJPY  | 28   | +0.03%   | **2.19%**   | 3.23%| ニュートラル |
| USDTRY  | 28   | +0.68%   | **1.44%**   | 2.72%| やや高め |
| TRYJPY  | 28   | -0.57%   | **3.38%**   | 4.46%| やや低め |

**総合評価:**
- **平均MAE: 2.34%**
- **平均RMSE: 3.47%**
- **評価: [GOOD] 良好な精度**

---

### 主要な発見

#### 1. 精度特性

**全期間:**
- 平均誤差: 2.83%（1か月先予想として良好）
- バイアス: ほぼゼロ（全て±0.2%以内）

**安定期:**
- 平均誤差: 2.34%（精度向上）
- USDTRYで特に高精度（MAE 1.44%）

#### 2. 誤差分布（安定期・USDTRY）

| 誤差範囲 | 件数 | 割合 |
|---------|------|------|
| 0-1%    | 18件 | **64.3%** |
| 1-2%    | 7件  | 25.0% |
| 2-3%    | 1件  | 3.6% |
| 3-5%    | 0件  | 0.0% |
| 5-10%   | 1件  | 3.6% |
| 10%+    | 1件  | 3.6% |

→ **約9割が誤差2%以内**

#### 3. 最大の外れ値

**USDJPY:**
1. 2024-08: 8.86%（大きな市場変動）
2. 2023-12: 7.71%
3. 2024-10: 7.45%

**USDTRY:**
1. 2023-06: 15.15%（トルコ大統領選挙）
2. 2023-09: 10.29%
3. 2023-08: 8.62%

**TRYJPY:**
1. 2024-08: 11.08%
2. 2023-06: 14.00%
3. 2023-08: 8.80%

→ **政治イベントや大きな市場変動時に外れやすい**

#### 4. バイアス特性

| 通貨ペア | 全期間 | 安定期 |
|---------|--------|--------|
| USDJPY  | +0.00% | +0.03% |
| USDTRY  | +0.17% | +0.68% |
| TRYJPY  | -0.03% | -0.57% |

→ **構造的な偏りが少なく、ほぼニュートラル**

---

## データソース

### 使用データセット

**入力データ:**
- `../dataset/monthly_mci_backtest_ready_2022_2025.csv`

**内容:**
- 月次為替レート（S_USDJPY, S_USDTRY, S_TRYJPY）
- PPP値（PPP_JPY, PPP_TRY）
- m座標（m_USD, m_JPY, m_TRY）
- 前月とのm座標変動（delta_m_USD, delta_m_JPY, delta_m_TRY）
- **3カ月移動平均**（avg_delta_m_USD_3m, avg_delta_m_JPY_3m, avg_delta_m_TRY_3m）

**データ作成:**
```bash
cd ../dataset
python create_backtest_dataset.py      # delta_m_* を追加
python add_rolling_averages.py          # avg_delta_m_*_3m を追加
```

### データ特性

- **PPP**: 年次PPPを月次で線形補間（実験的）
- **為替レート**: IMF IFS月次平均レート
- **期間**: 2022-01〜2025-11（47ヶ月）
- **PPP 2025年**: IMF WEO October 2025の投影値（確定値は2026年10月公表予定）

---

## 出力ファイル

### `backtest_rolling_avg_results.csv`

全期間のバックテスト結果（45ヶ月分）

**列構成:**

| 列名 | 説明 |
|------|------|
| `base_month` | 基準月（この月のデータを使って予想） |
| `target_month` | 予想対象月（この月の実績と比較） |
| `pred_USDJPY` | USD/JPY予想値 |
| `actual_USDJPY` | USD/JPY実績値 |
| `error_pct_USDJPY` | USD/JPY誤差率（%） |
| `pred_USDTRY` | USD/TRY予想値 |
| `actual_USDTRY` | USD/TRY実績値 |
| `error_pct_USDTRY` | USD/TRY誤差率（%） |
| `pred_TRYJPY` | TRY/JPY予想値 |
| `actual_TRYJPY` | TRY/JPY実績値 |
| `error_pct_TRYJPY` | TRY/JPY誤差率（%） |
| `avg_delta_m_USD` | 使用したUSD m座標3カ月平均変動 |
| `avg_delta_m_JPY` | 使用したJPY m座標3カ月平均変動 |
| `avg_delta_m_TRY` | 使用したTRY m座標3カ月平均変動 |

---

## 評価レポート

詳細な評価は以下を参照:

**`BACKTEST_EVALUATION_REPORT.md`**
- バックテスト手法の詳細
- 全期間 vs 安定期の比較
- 混乱期（政治イベント期）の特徴
- 実務的な観点からの総合評価

---

## 注意事項

### データの制約
- 月次平均レートを使用しているため、月内の急激な変動は捉えられない
- 2025年のPPPは投影値（確定値は2026年10月公表）
- 政治イベント等の突発的要因による変動は予測困難

### 実務での利用
- あくまで統計的・理論的アプローチ
- 実際の取引判断には追加の分析が必要
- 政治イベント時は精度が低下する可能性に注意
- 短期のフロー主導相場（日銀介入、急激な金利変動等）には弱い

---

**作成日**: 2025-12-01
**論文参照**: `../docs/FULL_PAPER_CORRECTED.md` 第8章
